<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Видеочат без цензуры</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1000px;
            background-color: #2d2d2d;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            border: 1px solid #444;
        }

        .video-streams {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            padding: 15px;
            gap: 15px;
            background-color: #1e1e1e;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .video-streams {
                flex-direction: row;
                height: 450px;
            }
        }

        .video-box {
            position: relative;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1 1 45%;
            width: 100%;
            max-width: 480px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }
        
        @media (min-width: 768px) {
            .video-box {
                flex-basis: calc(50% - 15px);
                height: 100%;
            }
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 20px;
            background-color: #2d2d2d;
            border-top: 1px solid #3a3a3a;
        }
        
        .status-message {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #ccc;
            margin: 0;
            padding: 10px;
        }

        .id-container {
            display: none;
        }

        .copy-button {
            display: none;
        }
        
        .call-container {
            display: none;
        }

        button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }

        #start-button {
            background-image: linear-gradient(45deg, #1e90ff, #0077c2);
            color: #fff;
        }

        #start-button.video-mode {
            background-image: linear-gradient(45deg, #4CAF50, #388E3C);
        }
        
        #next-button {
            background-image: linear-gradient(45deg, #ff6347, #e54c33);
            color: #fff;
        }

        #select-file-button {
            background-color: #555;
            color: #fff;
        }
        
        #chat-section {
            display: none;
            flex-direction: column;
            padding: 20px;
            background-color: #222;
            border-top: 1px solid #333;
        }

        #chat-box {
            height: 150px;
            background-color: #333;
            border-radius: 8px;
            border: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        #message-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #444;
            color: #f0f2f5;
            box-sizing: border-box;
            outline: none;
        }

        #message-input::placeholder {
            color: #aaa;
        }
        
        .message {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .self-message {
            text-align: right;
            color: #79a1d3;
        }
        
        .other-message {
            text-align: left;
            color: #f0f2f5;
        }

    </style>
</head>
<body>

<div class="chat-container">
    <div class="video-streams">
        <div class="video-box">
            <video id="local-video" muted autoplay playsinline></video>
        </div>
        <div class="video-box">
            <video id="remote-video" autoplay playsinline></video>
        </div>
    </div>

    <div class="controls">
        <p id="status-message" class="status-message">Нажмите "Старт", чтобы начать</p>
        <button id="select-file-button">
            <i class="fas fa-video"></i> Использовать видеофайл
        </button>
        <input type="file" id="video-file-input" accept="video/*" style="display: none;">
        <button id="start-button">
            <i class="fas fa-play"></i> Старт
        </button>
        <button id="next-button" style="display: none;">
            <i class="fas fa-arrow-right-to-bracket"></i> Следующий
        </button>
    </div>
    
    <div id="chat-section">
        <div id="chat-box"></div>
        <input type="text" id="message-input" placeholder="Введите сообщение...">
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        setLogLevel('debug'); // for debugging purposes
        
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const startButton = document.getElementById('start-button');
        const nextButton = document.getElementById('next-button');
        const statusMessage = document.getElementById('status-message');
        const chatSection = document.getElementById('chat-section');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const selectFileButton = document.getElementById('select-file-button');
        const videoFileInput = document.getElementById('video-file-input');
        
        // --- Firebase & PeerJS variables ---
        let app, db, auth;
        let userId = null;
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let dataConnection = null;
        let userDocRef = null;
        let unsubscribe = null;
        let isConnected = false;
        let isVideoFileMode = false;

        const PEER_SERVER = {
            host: '0.peerjs.com',
            secure: true,
            port: 443
        };

        // --- Firebase Initialization ---
        const initializeFirebase = async () => {
            try {
                // Check if the app is running in the Canvas environment
                if (typeof __firebase_config === 'undefined' || typeof __initial_auth_token === 'undefined') {
                    console.error("Firebase variables are not defined. This code is designed for the Canvas environment.");
                    console.error("To deploy externally, you must provide your own Firebase config and handle authentication.");
                    statusMessage.textContent = "Ошибка: Firebase не настроен для внешнего развертывания.";
                    // Optionally, you can return here to prevent further errors
                    // return;
                }
                
                // If variables are available (in Canvas), use them. Otherwise, provide a placeholder.
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "YOUR_API_KEY",
                    authDomain: "YOUR_AUTH_DOMAIN",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                    appId: "YOUR_APP_ID"
                };

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token if available, otherwise anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        console.log("Firebase not authenticated.");
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                statusMessage.textContent = "Ошибка Firebase: " + error.message;
            }
        };

        const displayMessage = (message, sender) => {
            const p = document.createElement('p');
            p.textContent = message;
            p.classList.add('message');
            p.classList.add(sender === 'self' ? 'self-message' : 'other-message');
            chatBox.appendChild(p);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // --- Main Chat Logic ---
        const startRandomChat = async () => {
            if (!userId) {
                console.warn("User not authenticated yet. Retrying startChat.");
                statusMessage.textContent = "Ожидание аутентификации пользователя...";
                setTimeout(startRandomChat, 500);
                return;
            }

            try {
                // Clear any previous streams
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                remoteVideo.srcObject = null;
                isConnected = false;

                // Determine video source
                if (isVideoFileMode && localVideo.src) {
                    statusMessage.textContent = 'Используется видеофайл...';
                    localVideo.play();
                    localStream = localVideo.captureStream();
                } else {
                    statusMessage.textContent = 'Запрашиваем доступ к камере и микрофону...';
                    localVideo.srcObject = null; // Clear old video source
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                }
                
                statusMessage.textContent = 'Поиск собеседника...';
                if (peer) {
                    peer.destroy();
                }
                peer = new Peer(undefined, PEER_SERVER);

                peer.on('open', async (id) => {
                    console.log('My Peer ID is:', id);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const publicCollection = collection(db, `artifacts/${appId}/public/data/available_peers`);
                    const myDocId = `${userId}-${Date.now()}`;
                    userDocRef = doc(publicCollection, myDocId);

                    // Add user to the queue with a unique ID
                    await setDoc(userDocRef, {
                        peerId: id,
                        timestamp: serverTimestamp()
                    });
                    
                    // Listen for real-time changes in the collection
                    unsubscribe = onSnapshot(publicCollection, async (snapshot) => {
                        if (isConnected) return; // Prevent multiple connections

                        // Filter for valid peers with timestamps
                        const validPeers = snapshot.docs
                            .filter(doc => doc.data().timestamp)
                            .map(doc => ({ ...doc.data(), id: doc.id }));

                        if (validPeers.length > 1) {
                            const sortedPeers = validPeers.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                            const newestPeer = sortedPeers[0];
                            
                            if (newestPeer.id === myDocId) {
                                const partnerPeer = sortedPeers.find(p => p.id !== myDocId);
                                if (!partnerPeer) {
                                    return; // Should not happen with length check, but for safety
                                }
                                console.log(`Found a partner: ${partnerPeer.peerId}`);
                                
                                // Clean up our entry from the database
                                if (unsubscribe) {
                                    unsubscribe();
                                }
                                await deleteDoc(doc(publicCollection, partnerPeer.id));
                                await deleteDoc(userDocRef);

                                // Initiate the call
                                const call = peer.call(partnerPeer.peerId, localStream);
                                call.on('stream', (remoteStream) => {
                                    remoteVideo.srcObject = remoteStream;
                                    updateStatus('connected');
                                });
                                call.on('close', () => disconnect());
                                currentCall = call;

                                // Establish data connection
                                dataConnection = peer.connect(partnerPeer.peerId);
                                dataConnection.on('open', () => chatSection.style.display = 'flex');
                                dataConnection.on('data', (data) => displayMessage(data, 'other'));
                                dataConnection.on('close', () => disconnect());
                            }
                        }
                    });
                });

                peer.on('call', (call) => {
                    if (isConnected) {
                        call.close();
                        return;
                    }
                    console.log('Incoming call, accepting...');
                    
                    // Clean up our document from the database
                    if (unsubscribe) {
                        unsubscribe();
                    }
                    if (userDocRef) {
                        deleteDoc(userDocRef);
                    }
                    
                    currentCall = call;
                    call.answer(localStream);
                    call.on('stream', (remoteStream) => {
                        remoteVideo.srcObject = remoteStream;
                        updateStatus('connected');
                    });
                    call.on('close', () => disconnect());
                });

                peer.on('connection', (conn) => {
                    if (isConnected) {
                        conn.close();
                        return;
                    }
                    console.log('Incoming data connection');
                    dataConnection = conn;
                    dataConnection.on('open', () => chatSection.style.display = 'flex');
                    dataConnection.on('data', (data) => displayMessage(data, 'other'));
                    dataConnection.on('close', () => disconnect());
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    // Provide a user-friendly error message on the UI
                    statusMessage.textContent = 'Ошибка подключения. Пожалуйста, нажмите "Следующий", чтобы попробовать снова.';
                    // Ensure state is clean for a new connection attempt
                    disconnect();
                });
                
            } catch (err) {
                console.error('Error getting media:', err);
                statusMessage.textContent = 'Ошибка: Не удалось получить доступ к камере/микрофону.';
                startButton.style.display = 'block';
                nextButton.style.display = 'none';
            }
        };

        const disconnect = async () => {
            if (currentCall) {
                currentCall.close();
            }
            if (dataConnection) {
                dataConnection.close();
            }
            if (peer) {
                peer.destroy();
                peer = null;
            }

            if (unsubscribe) {
                unsubscribe();
            }
            
            if (userDocRef) {
                try {
                    await deleteDoc(userDocRef);
                    console.log("User entry removed from Firestore.");
                } catch (e) {
                    console.error("Error removing user entry from Firestore:", e);
                }
            }
            userDocRef = null;

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            remoteVideo.srcObject = null;
            isConnected = false;
            
            startButton.style.display = 'block';
            nextButton.style.display = 'none';
            chatSection.style.display = 'none';
            chatBox.innerHTML = '';
            statusMessage.textContent = 'Нажмите "Старт", чтобы начать';

            // Reset file mode
            isVideoFileMode = false;
            localVideo.src = '';
            startButton.textContent = "Старт";
            startButton.classList.remove('video-mode');
        };

        const updateStatus = (status) => {
            if (status === 'connected') {
                statusMessage.textContent = 'Вы подключены!';
                startButton.style.display = 'none';
                nextButton.style.display = 'block';
                isConnected = true;
            } else if (status === 'connecting') {
                statusMessage.textContent = 'Подключение...';
                startButton.style.display = 'none';
                nextButton.style.display = 'block';
            }
        };

        // --- Event Listeners ---
        startButton.addEventListener('click', startRandomChat);
        nextButton.addEventListener('click', () => {
            disconnect();
            startRandomChat();
        });

        // Handle video file selection
        selectFileButton.addEventListener('click', () => {
            videoFileInput.click();
        });

        videoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                localVideo.srcObject = null;
                localVideo.src = url;
                localVideo.loop = true; // Loop the video for continuous playback
                localVideo.muted = true; // Mute the local video
                localVideo.onloadeddata = () => {
                    localVideo.play();
                    isVideoFileMode = true;
                    statusMessage.textContent = `Видеофайл "${file.name}" готов. Нажмите "Старт".`;
                    startButton.textContent = "Начать с видеофайлом";
                    startButton.classList.add('video-mode');
                };
            }
        });

        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && messageInput.value.trim() !== '' && dataConnection && isConnected) {
                const message = messageInput.value;
                displayMessage(message, 'self');
                dataConnection.send(message);
                messageInput.value = '';
            }
        });

        initializeFirebase();
    });
</script>

</body>
</html>

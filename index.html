<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HackForum VideoChat</title>
  <script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- PeerJS ---
    import Peer from "https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js";

    // –¢–≤–æ–π Firebase-–∫–æ–Ω—Ñ–∏–≥
    const firebaseConfig = {
      apiKey: "AIzaSyBMbRnraQyUZtiMCLD8QY49ATlVAtIpY2A",
      authDomain: "hackforum-9f8d6.firebaseapp.com",
      projectId: "hackforum-9f8d6",
      storageBucket: "hackforum-9f8d6.appspot.com",
      messagingSenderId: "374379711001",
      appId: "1:374379711001:web:3daedc67a3c1c49a7db888",
      measurementId: "G-4L81Q5V76W"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- PeerJS –∫–ª–∏–µ–Ω—Ç ---
    let peer;
    let myStream;
    let currentCall;

    async function init() {
      try {
        // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        await signInAnonymously(auth);
        console.log("–ê–Ω–æ–Ω–∏–º–Ω–æ –≤–æ—à–ª–∏ –≤ Firebase");

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("myVideo").srcObject = myStream;

        // PeerJS
        peer = new Peer(undefined, {
          host: "0.peerjs.com",
          port: 443,
          secure: true
        });

        peer.on("open", async id => {
          console.log("–ú–æ–π PeerID:", id);

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ –æ—á–µ—Ä–µ–¥—å
          const ref = await addDoc(collection(db, "peers"), { peerId: id });
          console.log("–î–æ–±–∞–≤–∏–ª–∏ –≤ Firestore:", ref.id);

          // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏
          peer.on("call", call => {
            call.answer(myStream);
            call.on("stream", remoteStream => {
              document.getElementById("remoteVideo").srcObject = remoteStream;
            });
            currentCall = call;
          });

          // –°–ª—É—à–∞–µ–º Firestore (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤)
          onSnapshot(collection(db, "peers"), snapshot => {
            snapshot.docChanges().forEach(change => {
              if (change.type === "added" && change.doc.data().peerId !== id && !currentCall) {
                console.log("–ù–∞—à–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:", change.doc.data().peerId);
                const call = peer.call(change.doc.data().peerId, myStream);
                call.on("stream", remoteStream => {
                  document.getElementById("remoteVideo").srcObject = remoteStream;
                });
                currentCall = call;
              }
            });
          });
        });
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
      }
    }

    window.startChat = init;
  </script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #eee; }
    video { width: 45%; border: 2px solid #444; border-radius: 8px; margin: 10px; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üî• HackForum VideoChat</h1>
  <video id="myVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
  <br>
  <button onclick="startChat()">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
</body>
</html>
